name: Daily Stock Data Update

on:
  schedule:
    # æ¯æ—¥ 18:00 JST (09:00 UTC) ã«å®Ÿè¡Œ
    - cron: "0 9 * * *"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Install dependencies
        run: |
          go mod download
          mkdir -p data/raw
      
      - name: Download latest SQLite DB (if exists)
        continue-on-error: true
        run: |
          # GitHub APIã§æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
          
          if [ "$LATEST_TAG" != "null" ] && [ "$LATEST_TAG" != "" ]; then
            echo "ğŸ“¥ Found latest release: $LATEST_TAG"
            curl -L -o data/stock_data.db.gz \
              "https://github.com/${{ github.repository }}/releases/download/$LATEST_TAG/stock_data.db.gz" \
              || echo "âš ï¸ Download failed, starting fresh"
            
            if [ -f data/stock_data.db.gz ]; then
              gunzip data/stock_data.db.gz
              echo "âœ… Database restored from previous release"
            fi
          else
            echo "â„¹ï¸ No previous release found, starting fresh"
          fi
      
      - name: Fetch and parse EDINET data
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          echo "ğŸš€ Fetching data for: $TODAY"
          go run main.go -mode=run -date=$TODAY
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
      
      - name: Compress database
        run: |
          gzip -c data/stock_data.db > data/stock_data.db.gz
          echo "ğŸ“¦ Database compressed"
      
      - name: Generate release info
        id: db-info
        run: |
          DB_SIZE=$(stat -c%s data/stock_data.db.gz)
          DATE=$(date -u +%Y-%m-%d)
          echo "db_size=$DB_SIZE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Database size: $(numfmt --to=iec-i --suffix=B $DB_SIZE)"
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: data-${{ steps.db-info.outputs.date }}
          name: Stock Data - ${{ steps.db-info.outputs.date }}
          body: |
            ğŸ“Š Daily stock data update
            
            ğŸ—„ï¸ Database size: $(numfmt --to=iec-i --suffix=B ${{ steps.db-info.outputs.db_size }})
            ğŸ“… Updated: ${{ steps.db-info.outputs.date }}
            
            **Download:**
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/data-${{ steps.db-info.outputs.date }}/stock_data.db.gz
            gunzip stock_data.db.gz
            ```
            
            **Web Dashboard:**
            - [View Analysis](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})
          files: |
            data/stock_data.db.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest tag
        continue-on-error: true
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -f latest
          git push origin latest --force
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Daily update failed - ' + new Date().toISOString().split('T')[0],
              body: 'The daily stock data update workflow has failed. Please check the [workflow run](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ').',
              labels: ['automation', 'bug']
            });
