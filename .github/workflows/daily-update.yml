name: Daily Stock Data Update

on:
  schedule:
    # æ¯æ—¥ 18:00 JST (09:00 UTC) ã«å®Ÿè¡Œ
    - cron: "0 9 * * *"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      days_back:
        description: 'ä½•æ—¥å‰ã¾ã§é¡ã£ã¦å–å¾—ã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 7ï¼‰'
        required: false
        default: '7'

jobs:
  update-data:
    runs-on: ubuntu-latest

    permissions:
      contents: write    # ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã¨ã‚¿ã‚°ã®æ›´æ–°ã«å¿…è¦
      issues: write      # å¤±æ•—æ™‚ã®Issueä½œæˆã«å¿…è¦
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Install dependencies
        run: |
          go mod download
          mkdir -p data/raw
      
      - name: Download latest SQLite DB (if exists)
        continue-on-error: true
        run: |
          # GitHub APIã§æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‚’å–å¾—
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
          
          if [ "$LATEST_TAG" != "null" ] && [ "$LATEST_TAG" != "" ]; then
            echo "ğŸ“¥ Found latest release: $LATEST_TAG"
            curl -L -o data/stock_data.db.gz \
              "https://github.com/${{ github.repository }}/releases/download/$LATEST_TAG/stock_data.db.gz" \
              || echo "âš ï¸ Download failed, starting fresh"
            
            if [ -f data/stock_data.db.gz ]; then
              gunzip data/stock_data.db.gz
              echo "âœ… Database restored from previous release"
              # å¾©å…ƒå¾Œã®DBçµ±è¨ˆã‚’å‡ºåŠ›
              echo "ğŸ“Š Pre-update stats:"
              sqlite3 data/stock_data.db "SELECT COUNT(*) || ' total stocks' FROM stocks;"
              sqlite3 data/stock_data.db "SELECT COUNT(*) || ' with sales data' FROM stocks WHERE net_sales > 0;"
            fi
          else
            echo "â„¹ï¸ No previous release found, starting fresh"
          fi
      
      - name: Fetch EDINET data (multiple days)
        run: |
          DAYS_BACK=${{ github.event.inputs.days_back || '7' }}
          echo "ğŸš€ Fetching EDINET data for the past $DAYS_BACK days..."
          
          TOTAL_PROCESSED=0
          TOTAL_NEW=0
          
          for i in $(seq 0 $((DAYS_BACK - 1))); do
            TARGET_DATE=$(date -u -d "$i days ago" +%Y-%m-%d 2>/dev/null || date -u -v-${i}d +%Y-%m-%d)
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“… Processing: $TARGET_DATE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # å„æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ç¶šè¡Œï¼‰
            OUTPUT=$(go run main.go -mode=run -date=$TARGET_DATE 2>&1) || true
            echo "$OUTPUT"
            
            # å‡¦ç†ä»¶æ•°ã‚’æŠ½å‡ºã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
            PROCESSED=$(echo "$OUTPUT" | grep -oP 'å‡¦ç†=\K[0-9]+' || echo "0")
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + PROCESSED))
            
            if [ "$PROCESSED" -gt "0" ]; then
              TOTAL_NEW=$((TOTAL_NEW + PROCESSED))
              echo "âœ… $TARGET_DATE: $PROCESSED ä»¶è¿½åŠ "
            else
              echo "â­ï¸ $TARGET_DATE: æ–°è¦ãƒ‡ãƒ¼ã‚¿ãªã—"
            fi
            
            # EDINET APIã®ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå¯¾ç­–ï¼ˆ1ç§’å¾…æ©Ÿï¼‰
            sleep 1
          done
          
          echo ""
          echo "ğŸ”¥ === ãƒãƒƒãƒçµæœ ==="
          echo "  å¯¾è±¡æ—¥æ•°: $DAYS_BACK æ—¥"
          echo "  åˆè¨ˆå‡¦ç†: $TOTAL_PROCESSED ä»¶"
          echo "  æ–°è¦è¿½åŠ : $TOTAL_NEW ä»¶"
          
          # çµæœã‚’GitHub Outputã«ä¿å­˜
          echo "total_processed=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          echo "total_new=$TOTAL_NEW" >> $GITHUB_OUTPUT
        id: fetch-data
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}

      - name: Fetch stock prices
        continue-on-error: true
        run: |
          echo "ğŸ“ˆ Fetching latest stock prices..."
          go run main.go -mode=fetch-prices 2>&1 || echo "âš ï¸ Price fetch had issues"
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}

      - name: Post-update DB statistics
        run: |
          echo "ğŸ“Š Post-update statistics:"
          if [ -f data/stock_data.db ]; then
            sqlite3 data/stock_data.db "SELECT '  Total stocks: ' || COUNT(*) FROM stocks;"
            sqlite3 data/stock_data.db "SELECT '  With sales: ' || COUNT(*) FROM stocks WHERE net_sales > 0;"
            sqlite3 data/stock_data.db "SELECT '  With net_income: ' || COUNT(*) FROM stocks WHERE net_income > 0;"
            sqlite3 data/stock_data.db "SELECT '  With total_assets: ' || COUNT(*) FROM stocks WHERE total_assets > 0;"
            sqlite3 data/stock_data.db "SELECT '  With price: ' || COUNT(DISTINCT code) FROM stock_prices;"
            sqlite3 data/stock_data.db "SELECT '  Latest date: ' || MAX(updated_at) FROM stocks WHERE updated_at != '';"
          else
            echo "  âš ï¸ Database file not found"
          fi

      - name: Compress database
        run: |
          gzip -c data/stock_data.db > data/stock_data.db.gz
          echo "ğŸ“¦ Database compressed"
      
      - name: Generate release info
        id: db-info
        run: |
          DB_SIZE=$(stat -c%s data/stock_data.db.gz)
          DATE=$(date -u +%Y-%m-%d)
          STOCK_COUNT=$(sqlite3 data/stock_data.db "SELECT COUNT(*) FROM stocks;" 2>/dev/null || echo "unknown")
          SALES_COUNT=$(sqlite3 data/stock_data.db "SELECT COUNT(*) FROM stocks WHERE net_sales > 0;" 2>/dev/null || echo "unknown")
          echo "db_size=$DB_SIZE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "stock_count=$STOCK_COUNT" >> $GITHUB_OUTPUT
          echo "sales_count=$SALES_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Database size: $(numfmt --to=iec-i --suffix=B $DB_SIZE)"
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: data-${{ steps.db-info.outputs.date }}
          name: Stock Data - ${{ steps.db-info.outputs.date }}
          body: |
            ğŸ“Š Daily stock data update
            
            ğŸ“… Updated: ${{ steps.db-info.outputs.date }}
            ğŸ“ˆ Total stocks: ${{ steps.db-info.outputs.stock_count }}
            ğŸ’° With financial data: ${{ steps.db-info.outputs.sales_count }}
            ğŸ—„ï¸ Database size: ${{ steps.db-info.outputs.db_size }} bytes
            
            **Download:**
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/data-${{ steps.db-info.outputs.date }}/stock_data.db.gz
            gunzip stock_data.db.gz
            ```
            
            **Web Dashboard:**
            - [View Analysis](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})
          files: |
            data/stock_data.db.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest tag
        continue-on-error: true
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -f latest
          git push origin latest --force
      
      - name: Create issue on failure or zero data
        if: failure() || steps.fetch-data.outputs.total_processed == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const isFailure = '${{ job.status }}' === 'failure';
            const totalProcessed = '${{ steps.fetch-data.outputs.total_processed }}';
            
            let title, body;
            if (isFailure) {
              title = 'âš ï¸ Daily update failed - ' + new Date().toISOString().split('T')[0];
              body = 'The daily stock data update workflow has failed. Please check the [workflow run](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ').';
            } else {
              title = 'ğŸ“­ Daily update: 0 new records - ' + new Date().toISOString().split('T')[0];
              body = 'The daily update completed but added 0 new records. This may indicate:\n' +
                     '- No EDINET submissions on the target dates\n' +
                     '- EDINET API issues\n' +
                     '- XBRL parsing failures\n\n' +
                     'Check the [workflow run](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ').';
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automation', isFailure ? 'bug' : 'data-quality']
            });
