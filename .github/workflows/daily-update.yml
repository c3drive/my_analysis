name: Daily Stock Data Update

on:
  schedule:
    # æ¯æ—¥ 18:00 JST (09:00 UTC) ã«å®Ÿè¡Œ
    - cron: "0 9 * * *"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      days_back:
        description: 'ä½•æ—¥å‰ã¾ã§é¡ã£ã¦å–å¾—ã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 7ï¼‰'
        required: false
        default: '7'

jobs:
  update-data:
    runs-on: ubuntu-latest

    permissions:
      contents: write    # ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã¨ã‚¿ã‚°ã®æ›´æ–°ã«å¿…è¦
      issues: write      # å¤±æ•—æ™‚ã®Issueä½œæˆã«å¿…è¦
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Install dependencies
        run: |
          go mod download
          mkdir -p data/raw
      
      - name: Download latest DBs from release (if exists)
        continue-on-error: true
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
          
          if [ "$LATEST_TAG" != "null" ] && [ "$LATEST_TAG" != "" ]; then
            echo "ğŸ“¥ Found latest release: $LATEST_TAG"
            
            # 3-DBæ§‹æˆ: xbrl.db, stock_price.db, rs.db
            for DB_NAME in xbrl.db stock_price.db rs.db; do
              echo "  Downloading $DB_NAME..."
              curl -L -o "data/${DB_NAME}.gz" \
                "https://github.com/${{ github.repository }}/releases/download/$LATEST_TAG/${DB_NAME}.gz" \
                2>/dev/null || echo "  âš ï¸ $DB_NAME not found in release"
              
              if [ -f "data/${DB_NAME}.gz" ]; then
                gunzip "data/${DB_NAME}.gz"
                echo "  âœ… $DB_NAME restored"
              fi
            done
            
            # ãƒ¬ã‚¬ã‚·ãƒ¼DBå¯¾å¿œï¼ˆstock_data.db â†’ 3DBç§»è¡Œï¼‰
            if [ ! -f data/xbrl.db ]; then
              echo "  Trying legacy stock_data.db..."
              curl -L -o data/stock_data.db.gz \
                "https://github.com/${{ github.repository }}/releases/download/$LATEST_TAG/stock_data.db.gz" \
                2>/dev/null || echo "  âš ï¸ Legacy DB not found either"
              if [ -f data/stock_data.db.gz ]; then
                gunzip data/stock_data.db.gz
                echo "  âœ… Legacy DB restored (will be migrated on first run)"
              fi
            fi
            
            # å¾©å…ƒå¾Œã®DBçµ±è¨ˆã‚’å‡ºåŠ›
            echo "ğŸ“Š Pre-update stats:"
            if [ -f data/xbrl.db ]; then
              sqlite3 data/xbrl.db "SELECT COUNT(*) || ' total stocks' FROM stocks;" 2>/dev/null || true
              sqlite3 data/xbrl.db "SELECT COUNT(*) || ' with sales data' FROM stocks WHERE net_sales > 0;" 2>/dev/null || true
            fi
            if [ -f data/stock_price.db ]; then
              sqlite3 data/stock_price.db "SELECT COUNT(DISTINCT code) || ' stocks with prices' FROM stock_prices;" 2>/dev/null || true
            fi
          else
            echo "â„¹ï¸ No previous release found, starting fresh"
          fi
      
      - name: Fetch EDINET data (multiple days)
        run: |
          DAYS_BACK=${{ github.event.inputs.days_back || '7' }}
          echo "ğŸš€ Fetching EDINET data for the past $DAYS_BACK days..."
          
          TOTAL_PROCESSED=0
          TOTAL_NEW=0
          
          for i in $(seq 0 $((DAYS_BACK - 1))); do
            TARGET_DATE=$(date -u -d "$i days ago" +%Y-%m-%d 2>/dev/null || date -u -v-${i}d +%Y-%m-%d)
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“… Processing: $TARGET_DATE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            OUTPUT=$(go run main.go -mode=run -date=$TARGET_DATE 2>&1) || true
            echo "$OUTPUT"
            
            PROCESSED=$(echo "$OUTPUT" | grep -oP 'å‡¦ç†=\K[0-9]+' || echo "0")
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + PROCESSED))
            
            if [ "$PROCESSED" -gt "0" ]; then
              TOTAL_NEW=$((TOTAL_NEW + PROCESSED))
              echo "âœ… $TARGET_DATE: $PROCESSED ä»¶è¿½åŠ "
            else
              echo "â­ï¸ $TARGET_DATE: æ–°è¦ãƒ‡ãƒ¼ã‚¿ãªã—"
            fi
            
            sleep 1
          done
          
          echo ""
          echo "ğŸ”¥ === ãƒãƒƒãƒçµæœ ==="
          echo "  å¯¾è±¡æ—¥æ•°: $DAYS_BACK æ—¥"
          echo "  åˆè¨ˆå‡¦ç†: $TOTAL_PROCESSED ä»¶"
          echo "  æ–°è¦è¿½åŠ : $TOTAL_NEW ä»¶"
          
          echo "total_processed=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          echo "total_new=$TOTAL_NEW" >> $GITHUB_OUTPUT
        id: fetch-data
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}

      - name: Fetch stock prices
        continue-on-error: true
        run: |
          echo "ğŸ“ˆ Fetching latest stock prices..."
          go run main.go -mode=fetch-prices 2>&1 || echo "âš ï¸ Price fetch had issues"
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}

      - name: Post-update DB statistics
        run: |
          echo "ğŸ“Š Post-update statistics:"
          if [ -f data/xbrl.db ]; then
            sqlite3 data/xbrl.db "SELECT '  Total stocks: ' || COUNT(*) FROM stocks;"
            sqlite3 data/xbrl.db "SELECT '  With sales: ' || COUNT(*) FROM stocks WHERE net_sales > 0;"
            sqlite3 data/xbrl.db "SELECT '  With net_income: ' || COUNT(*) FROM stocks WHERE net_income > 0;"
            sqlite3 data/xbrl.db "SELECT '  With total_assets: ' || COUNT(*) FROM stocks WHERE total_assets > 0;"
            sqlite3 data/xbrl.db "SELECT '  Latest date: ' || MAX(updated_at) FROM stocks WHERE updated_at != '';"
          fi
          if [ -f data/stock_price.db ]; then
            sqlite3 data/stock_price.db "SELECT '  Stocks with prices: ' || COUNT(DISTINCT code) FROM stock_prices;"
          fi

      - name: Compress databases
        run: |
          for DB_NAME in xbrl.db stock_price.db rs.db; do
            if [ -f "data/$DB_NAME" ]; then
              gzip -c "data/$DB_NAME" > "data/${DB_NAME}.gz"
              echo "ğŸ“¦ Compressed $DB_NAME"
            fi
          done
      
      - name: Generate release info
        id: db-info
        run: |
          DATE=$(date -u +%Y-%m-%d)
          STOCK_COUNT=$(sqlite3 data/xbrl.db "SELECT COUNT(*) FROM stocks;" 2>/dev/null || echo "unknown")
          SALES_COUNT=$(sqlite3 data/xbrl.db "SELECT COUNT(*) FROM stocks WHERE net_sales > 0;" 2>/dev/null || echo "unknown")
          PRICE_COUNT=$(sqlite3 data/stock_price.db "SELECT COUNT(DISTINCT code) FROM stock_prices;" 2>/dev/null || echo "unknown")
          
          # åˆè¨ˆã‚µã‚¤ã‚º
          TOTAL_SIZE=0
          for f in data/xbrl.db.gz data/stock_price.db.gz data/rs.db.gz; do
            if [ -f "$f" ]; then
              SIZE=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f")
              TOTAL_SIZE=$((TOTAL_SIZE + SIZE))
            fi
          done
          
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "stock_count=$STOCK_COUNT" >> $GITHUB_OUTPUT
          echo "sales_count=$SALES_COUNT" >> $GITHUB_OUTPUT
          echo "price_count=$PRICE_COUNT" >> $GITHUB_OUTPUT
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: data-${{ steps.db-info.outputs.date }}
          name: Stock Data - ${{ steps.db-info.outputs.date }}
          body: |
            ğŸ“Š Daily stock data update (3-DB architecture)
            
            ğŸ“… Updated: ${{ steps.db-info.outputs.date }}
            ğŸ“ˆ Total stocks: ${{ steps.db-info.outputs.stock_count }}
            ğŸ’° With financial data: ${{ steps.db-info.outputs.sales_count }}
            ğŸ“‰ With price data: ${{ steps.db-info.outputs.price_count }}
            ğŸ—„ï¸ Total size: ${{ steps.db-info.outputs.total_size }} bytes
            
            **Files:**
            - `xbrl.db.gz` - è²¡å‹™ãƒ‡ãƒ¼ã‚¿ï¼ˆEDINET XBRLï¼‰
            - `stock_price.db.gz` - æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ï¼ˆStooqï¼‰
            - `rs.db.gz` - ãƒªãƒ©ãƒ†ã‚£ãƒ–ã‚¹ãƒˆãƒ¬ãƒ³ã‚°ã‚¹
            
            **Download:**
            ```bash
            for f in xbrl.db stock_price.db rs.db; do
              wget https://github.com/${{ github.repository }}/releases/download/data-${{ steps.db-info.outputs.date }}/${f}.gz
              gunzip ${f}.gz
            done
            ```
            
            **Web Dashboard:**
            - [View Analysis](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})
          files: |
            data/xbrl.db.gz
            data/stock_price.db.gz
            data/rs.db.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest tag
        continue-on-error: true
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -f latest
          git push origin latest --force
      
      - name: Create issue on failure or zero data
        if: failure() || steps.fetch-data.outputs.total_processed == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const isFailure = '${{ job.status }}' === 'failure';
            const totalProcessed = '${{ steps.fetch-data.outputs.total_processed }}';
            
            let title, body;
            if (isFailure) {
              title = 'âš ï¸ Daily update failed - ' + new Date().toISOString().split('T')[0];
              body = 'The daily stock data update workflow has failed. Please check the [workflow run](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ').';
            } else {
              title = 'ğŸ“­ Daily update: 0 new records - ' + new Date().toISOString().split('T')[0];
              body = 'The daily update completed but added 0 new records. This may indicate:\n' +
                     '- No EDINET submissions on the target dates\n' +
                     '- EDINET API issues\n' +
                     '- XBRL parsing failures\n\n' +
                     'Check the [workflow run](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ').';
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automation', isFailure ? 'bug' : 'data-quality']
            });
