# EDINET XBRL Analyzer - TODO リスト

**参考**: [kawasin73さんの記事](https://kawasin73.hatenablog.com/entry/2025/11/20/224346)

**最終更新**: 2026-02-22

---

## 🏗️ アーキテクチャ・インフラ

> **方針**: S3は使わず、GitHub Releases + GitHub Pages でシンプルに構成

### 0. データソース拡張
- [ ] **TDNET対応** ← 現在はEDINETのみ
  - 適時開示情報の取得
  - 決算発表日の特定

### 1. ストレージ構成（GitHub Releases）
- [x] SQLiteファイルをGitHub Releasesにアップロード（daily-update.yml）
- [ ] **Raw XBRL files** をtar.gz化してReleasesに保存（オプション）
- [x] gzip圧縮版DBの配置（daily-update.ymlで実装済み）

### 2. GitHub Actions 拡張
- [x] 最新ReleasesからSQLiteダウンロード
- [x] 更新済みSQLiteをReleasesにアップロード
- [ ] **GitHub Actions Summary** にDB downloadリンク表示
- [ ] 解析ページリンクをSummaryに出力
- [ ] **新規銘柄発見時のIssue作成**（Daily Notification）

### 3. GitHub Pages ページ構成
- [x] `oneil-screen.html` - オニール成長株アナライザー（プレースホルダー）
- [x] `net-net-value.html` - ネットネットバリュー（プレースホルダー）
- [x] `market-top.html` - マーケット天井検出（プレースホルダー）
- [x] sqlite-wasm または 静的JSON でDB読み込み（Go API + 静的JSONハイブリッド対応済み）

### 4. Use Cases 対応
- [ ] **Local Development**: GitHub Releases からDB取得
- [ ] **Local Evaluation**: ブラウザからSQLite/JSON読み込み
- [ ] **Quick Evaluation**: GitHub Pages で直接解析
- [ ] **Daily Notification**: GitHub Issue → メール通知

---

## 🔴 高優先度（記事の主要機能を再現するために必須）

### 🚨 最重要課題：データが古い＆少ない問題（2026-02-22 詳細調査）

#### 📊 現状データ（ローカルDB `data/stock_data.db`）
| 指標 | 値 | 問題 |
|------|------|------|
| 全銘柄数 | 640社 | 東証上場 ~3,900社に対し16%しかカバーしていない |
| 売上データあり | 37社 (5.8%) | 大半が売上0 → 財務データが取れていない |
| 純利益データあり | 19社 (3.0%) | ほぼ分析不能 |
| 総資産データあり | 20社 (3.1%) | |
| 株価データあり | 490社 (76.5%) | Stooqで取得 → 比較的OK |
| DB内の最古日付 | (空) | 638件は `updated_at` が空 |
| DB内の最新日付 | 2025-12-25 | **2ヶ月前のデータ** |

#### 🔍 根本原因分析

**原因1: daily-update.yml が新規データを蓄積していない**
- GitHub Actionsは毎日 `success` で完了している（run 36〜40: 2/17〜2/21全成功）
- しかし、各run は30秒以内で終了 → **XBRLダウンロード0件の可能性大**
- ワークフローは最新リリースDBを復元 → 当日1日分だけ追加 → 新リリース作成
- **当日にEDINET提出がない日**（休日、祝日）は何も追加されずにDBがそのまま再アップロードされる
- タグ `data-2026-01-24` 以降にDBにデータが蓄積されていない（`latest`タグもここで止まっている）

**原因2: 初期データが2025-12-25の1日分のみ**
- `runCollector` は `-date` で指定した1日分のみ取得する設計
- DB内の640件は初回（2025-12-25）のみで取得されたもの
- その後の daily-update で追加された件数が極めて少ない（各日10〜30件程度）
- **過去の有価証券報告書を遡って取得する仕組みがない**

**原因3: deploy-pages.yml がハードコードされた古い日付を使用**
- `deploy-pages.yml` 28行目: `go run main.go -mode=run -date=2025-11-13` → **固定日付**
- GitHub Pages のデプロイは `2025-11-13` のデータのみで静的JSON(`stocks.json`)を生成
- デプロイ環境のダッシュボードも古いデータ

**原因4: XBRLパース成功率が低い**
- 640件中37件（5.8%）しか売上データを取得できていない
- XBRLの正規表現パターンがEDINETの実際のフォーマットと合っていない可能性
- 書類をダウンロードしても財務データの抽出に失敗 → 空データとして保存される

#### ✅ 対策TODO（優先度順）

**Phase 1: 即効性のある修正** ✅ 完了
- [x] **deploy-pages.yml の日付をハードコードから動的に変更**
  - 固定日付を廃止 → 最新リリースDBをダウンロードする方式に変更
  - daily-update完了後に `workflow_run` で自動デプロイをトリガー
- [x] **daily-update.yml にデータ蓄積ログを追加**
  - XBRLダウンロード・パース結果の件数をログに出力
  - 0件の場合にIssue通知（`data-quality`ラベル付き）
- [x] **daily-update.yml を複数日遡って取得する形に改善**
  - 当日だけでなく過去7日分を順番に取得（手動実行時に日数変更可能）
  - `INSERT OR REPLACE` なので重複問題なし
- [x] **deploy-pages.yml の gen_json.go を全カラム対応**
  - `Code, Name, NetSales, UpdatedAt` → 全財務データ + 株価 + 指標

**Phase 2: データ量の大幅改善（バッチ取得）**
- [x] **過去1年分のEDINETデータを一括取得するバッチモード実装**
  - `main.go` に `-mode=batch -from=2025-04-01 -to=2026-02-22` モード追加
  - 日付を1日ずつ走査して `runCollector` を繰り返し呼び出す
  - EDINET API のレートリミットに注意（1秒間隔のスリープ等）
  - 土日は自動スキップ

**Phase 3: XBRLパース改善**
- [ ] **XBRLパースの正規表現を改善**（EDINETの実際のタグ形式を調査）
- [ ] **テスト用にXBRLファイルをダウンロードして解析ログを出力**
- [ ] **有価証券報告書（docTypeCode=120）を優先的にパース**
- [ ] **四半期報告書（140）・半期報告書（160）のXBRL形式にも対応**

**Phase 4: データカバレッジ拡大**
- [ ] **日本株全銘柄リスト**を外部から取得（JPX証券コード一覧CSV）
- [ ] **EDINET提出書類のない企業の基本情報を補完**
- [ ] **deploy-pages.yml の gen_json.go を最新の全カラムに対応**
  - 現在は `Code, Name, NetSales, UpdatedAt` の4項目のみ
  - → 全財務データ + 株価 + 投資指標を出力するように拡張


### 5. データベース構成の変更（3ファイル構成） ✅ 完了
現在: 3つのDBファイル構成（旧stock_data.dbから自動マイグレーション対応）

- [x] `xbrl.db` - 財務データ用DB（56KB, 640銘柄）
- [x] `stock_price.db` - 株価データ用DB（7.7MB, 119,922レコード）
- [x] `rs.db` - リラティブストレングス用DB（テーブル構造作成済み）
- [x] サーバーで `ATTACH DATABASE` によるクロスDB JOIN
- [x] `migrateFromLegacyDB()` による自動移行

### 6. XBRLパース項目の拡張

#### 資産項目（ネットネット計算用）
- [x] `cash_and_deposits` - 現金及び預金（main.go実装済み）
- [ ] `deposits` - 預金
- [ ] `investment_securities` - 投資有価証券
- [ ] `accounts_receivable` - 売掛金
- [ ] `marketable_securities` - 有価証券
- [ ] `notes_receivable` - 受取手形
- [ ] `inventories` - 棚卸資産

#### 負債項目
- [x] `liabilities` - 負債合計（main.go実装済み）
- [x] `current_liabilities` - 流動負債（main.go実装済み）
- [ ] `non_current_liabilities` - 固定負債

#### 利益・資本項目
- [x] `net_income` - 純利益（main.go実装済み）
- [x] `operating_income` - 営業利益（main.go実装済み）
- [x] `net_assets` - 純資産（main.go実装済み）
- [x] `total_assets` - 総資産（main.go実装済み）
- [x] `current_assets` - 流動資産（main.go実装済み）
- [ ] `shareholders_equity` - 株主資本
- [x] `eps` - 1株当たり利益（純利益÷発行済株式数で計算）
- [x] `number_of_shares` - 発行済株式数（main.go実装済み）
- [x] `roe` - 自己資本利益率（純利益÷純資産×100で計算）

### 7. 株価データの取得
- [x] 外部APIから日次株価を取得（Stooq API使用）
- [x] 株価テーブル（code, date, open, high, low, close, volume）
- [x] 時価総額の計算（株価 × 発行済株式数）
- [x] 自己資本比率の計算・表示
- [x] PER（株価収益率）の計算・表示
- [x] PBR（株価純資産倍率）の計算・表示
- [x] ネットネット値の計算・表示

---

## 📊 オニール成長株アナライザー機能

### 4. パラメータ設定UI（左パネル）

#### 基本設定
- [ ] 基準日: yyyy/mm/dd（日付ピッカー）
- [ ] 利益タイプ選択: 純利益 (Net Income) / 営業利益

#### スクリーニング閾値
- [ ] Q0 EPS%: デフォルト 25
- [ ] Q1 EPS%: デフォルト 25
- [ ] Q0 売上%: デフォルト 25
- [ ] 年間EPS%: デフォルト 25
- [x] ROE%: デフォルト 17 → 実装済み
- [ ] RS: デフォルト 85

#### ランキングウェイト
- [ ] Q0: デフォルト 0.5
- [ ] Q1: デフォルト 0.3
- [ ] 2Y: デフォルト 0.2

### 5. 成長株ランキングテーブル（✅ 基本実装完了）
| カラム | 説明 | 実装状態 |
|--------|------|---------|
| コード | 証券コード | ✅ |
| 企業名 | 会社名 | ✅ |
| SCORE | 加重スコア | ✅ |
| Q0 EPS% | 直近四半期EPS成長率 | 📋 要データ |
| Q1 EPS% | 1四半期前EPS成長率 | 📋 要データ |
| 2Y CAGR% | 2年間年平均成長率 | 📋 要データ |
| Y0 EPS% | 今期EPS成長率 | 📋 要データ |
| ROE% | 自己資本利益率 | ✅ |
| RS | リラティブストレングス | 📋 要データ |
| 自己資本率% | 自己資本比率 | ✅ |
| 時価総額(億) | 時価総額 | ✅ |


### 6. 銘柄詳細ページ

#### ヘッダー
- [ ] ←ランキングに戻る ナビゲーション
- [ ] 会社名 + 証券コード表示
- [ ] 日足/週足 切り替えボタン

#### 株価チャート
- [ ] ローソク足チャート
- [ ] 出来高バー
- [ ] 移動平均線
- [ ] **決算発表期間の背景色ハイライト**（黄色/オレンジ）

#### 主要指標カード
- [ ] 最新ROE (通期): XX.X%
- [ ] 最新EPS YoY (四半期): XXXX.X%
- [ ] 最新売上 YoY (四半期): XX.X%
- [ ] 最新EPS YoY (通期): XX.X%
- [ ] 3年EPS CAGR: XX.X%
- [ ] RS: XX

### 7. 財務データ詳細ページ（複数チャートグリッド）
- [ ] ROE (通期) 折れ線チャート
- [ ] 四半期 純利益EPS (Log) 折れ線チャート
- [ ] 四半期 純利益EPS YoY 棒グラフ
- [ ] 連期 純利益EPS (Log) 折れ線チャート
- [ ] 連期 純利益EPS YoY 棒グラフ
- [ ] 四半期 売上高 (Log) 折れ線チャート
- [ ] 四半期 売上高 YoY 棒グラフ

---

## 📈 市場天井検出ツール機能

### 8. 基本設定
- [ ] DBファイル選択（Choose File）
- [ ] 指数選択プルダウン（S&P 500, 日経平均, etc.）

### 9. マーカー表示トグル
- [ ] 分配日 (D) ON/OFF スイッチ
- [ ] ストーリング (S) ON/OFF スイッチ

### 10. 分配日 (Distribution) パラメータ
- [ ] 下落率 (以上): スライダー（デフォルト -0.2%）
- [ ] 条件表示: 終値変化率 <= -0.29%

### 11. ストーリング (Stalling) パラメータ
- [ ] 変化率 (下限): スライダー（デフォルト -0.1）
- [ ] 変化率 (上限): スライダー（デフォルト +0.3）
- [ ] 条件表示

### 12. 共通条件: 出来高
- [ ] 平均日数 (Y): スライダー（デフォルト 25日）
- [ ] 増加率 (X): スライダー（デフォルト 5.0%）
- [ ] AND条件チェックボックス

### 13. 注意期間 (背景色) パラメータ
- [ ] 判定日数 (N): スライダー（デフォルト 25日）
- [ ] マーカー個数 合計 (M): スライダー（デフォルト 6個）
- [ ] 分配日 閾値 (M_d): スライダー（デフォルト 4個）

### 14. 市場天井チャート
- [ ] ローソク足チャート
- [ ] 出来高バー
- [ ] **注意期間の黄色背景ハイライト**
- [ ] 分配日マーカー（赤）
- [ ] ストーリングマーカー（緑）
- [ ] 水平ライン（価格レベル）

---

## 💎 ネットネットバリュー機能

### 15. PBR計算式のカスタマイズ
- [x] 資産項目の選択UI（係数付き）
- [x] 負債項目の選択UI（係数付き）
- [ ] 項目の追加・削除機能
- [x] スペシャルPBR計算

### 16. 計算オプション
- [x] 上位N社を計算（全件表示）
- [ ] 特定日で計算（日付ピッカー）
- [ ] 証券コードで追加

### 17. タブ切り替え
- [x] ランキングタブ
- [ ] PBRチャートタブ
- [ ] カスタムチャートタブ

### 18. ランキングテーブル
- [x] 順位
- [x] 証券コード
- [x] 会社名
- [x] スペシャルPBR（クリックで詳細）
- [x] PBR
- [x] 自己資本比率 (%)
- [x] 時価総額 (億円)

---

## 🟡 中優先度

### 19. チャートライブラリ
- [ ] **lightweight-charts (TradingView)** の導入
- [ ] ローソク足チャート
- [ ] 出来高チャート
- [ ] 折れ線チャート
- [ ] 棒グラフ
- [ ] マーカー表示
- [ ] 背景色ハイライト

### 20. リラティブストレングス (RS) 計算
- [ ] RS値の計算ロジック
- [ ] RS用DBへの保存
- [ ] RS推移チャート

### 21. 新規銘柄発見時の通知
- [ ] 条件を満たす銘柄の検出
- [ ] GitHub Issue自動作成
- [ ] 銘柄詳細情報をIssue本文に

### 22. ローカルDBファイルアップロード
- [ ] Choose File ボタン（3ファイル対応）
- [ ] プログレスバー表示
- [ ] ダウンロード完了!表示

---

## 🟢 低優先度

### 23. sqlite-wasm の対応
- [ ] ブラウザ内でDB読み込み
- [ ] クエリ実行

### 24. S3への永続化（オプション）
- [ ] 生XBRLファイルのS3アップロード
- [ ] SQLiteファイルのS3保存

### 25. UI/UXの向上
- [ ] SPA化（1ファイルHTML）
- [ ] レスポンシブデザイン
- [ ] 値クリックで詳細ポップアップ

---

## ✅ 完了済み

### インフラ・基盤
- [x] Docker環境構築
- [x] EDINET APIからの書類取得
- [x] SQLite保存（拡張スキーマ対応）
- [x] GitHub Actions日次バッチ（daily-update.yml）
- [x] GitHub Pagesデプロイ（deploy-pages.yml）
- [x] gzip圧縮版DBの配置

### XBRLパース
- [x] 売上高（NetSales）
- [x] 営業利益（OperatingIncome）
- [x] 純利益（NetIncome / ProfitLoss）
- [x] 総資産（TotalAssets / Assets）
- [x] 純資産（NetAssets）
- [x] 流動資産（CurrentAssets）
- [x] 負債合計（Liabilities）
- [x] 流動負債（CurrentLiabilities）
- [x] 現金及び預金（CashAndDeposits）
- [x] 発行済株式数（SharesIssued）

### フロントエンド
- [x] 基本ダッシュボード（ダークモードUI）
- [x] 分析ページのプレースホルダー作成（net-net-value.html, oneil-screen.html, market-top.html）
- [x] Go API + 静的JSONのハイブリッド対応
- [x] テーブルに財務項目列追加（営業利益、純利益、総資産、純資産）
- [x] 金額を億円単位で表示
- [x] テーブルソート機能（ヘッダークリックで昇順/降順切り替え）
- [x] サーバー起動時のDBマイグレーション自動実行
- [x] 検索機能（証券コード・企業名でリアルタイム検索）
- [x] 「データありのみ」フィルター機能
- [x] CSVエクスポート機能（BOM付きでExcel対応）

### 株価データ
- [x] Stooq APIから日次株価を取得（fetch-pricesモード）
- [x] stock_pricesテーブル作成（code, date, open, high, low, close, volume）
- [x] 最新株価をダッシュボードに表示
- [x] 時価総額の計算・表示（株価 × 発行済株式数）
- [x] /api/prices/{code} エンドポイント追加

---

## 📊 機能比較サマリー

| 機能 | kawasin73さん | 現プロジェクト |
|------|--------------|----------------|
| DB構成 | 3ファイル (xbrl/stock_price/rs) | 1ファイル ❌ |
| XBRLパース | 多数の財務項目 | **主要10項目 ✅** |
| 株価データ | あり | **Stooq API ✅** |
| ネットネット計算 | カスタム係数対応 | なし ❌（データは取得済み） |
| オニールスクリーニング | 完全実装 | なし ❌ |
| RS計算 | 専用DB | なし ❌ |
| 市場天井検出 | パラメータ調整可能 | なし ❌ |
| チャート | lightweight-charts | なし ❌ |
| 決算期間ハイライト | あり | なし ❌ |
| 銘柄詳細ページ | 複数チャート | なし ❌ |

---

## 🎯 推奨実装順序（更新版）

~~1. **XBRLパース拡張** → 全ての計算の基礎~~ ✅ 完了

~~1. **EPS計算ロジック** → 純利益÷発行済株式数で計算可能に~~ ✅ 完了（ROEも実装済み）
2. ~~**株価データ取得** → RS・時価総額に必須~~ ✅ Stooq実装済み
3. ~~**ネットネット計算UI実装** → 取得済みデータで計算可能~~ ✅ 完了
4. ~~**3DB構成に変更** → xbrl.db / stock_price.db / rs.db~~ ✅ 完了
5. **lightweight-charts導入** → チャート表示の基盤
6. **オニールランキング実装** → スコア計算・テーブル
7. **銘柄詳細ページ** → チャート・主要指標
8. **市場天井検出** → パラメータUI・チャート
9. **ネットネット計算** → カスタム係数対応
